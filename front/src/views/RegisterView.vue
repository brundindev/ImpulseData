<template>
  <div class="register-container">
    <div class="register-card">
      <h1>Reg√≠strate</h1>
      <div v-if="error" class="alert alert-danger">{{ error }}</div>
      <div v-if="registroExitoso" class="alert alert-success">
        <div class="success-icon">
          <i class="checkmark">‚úì</i>
        </div>
        <h2>¬°Registro exitoso!</h2>
        <p>Hemos enviado un correo de verificaci√≥n a tu direcci√≥n de email.</p>
        <p><strong>{{ emailRegistrado }}</strong></p>
        <p>Por favor, verifica tu email antes de iniciar sesi√≥n.</p>
        <div v-if="!verificacionEnviada" class="verification-section">
          <p class="small-text">¬øNo has recibido el correo de verificaci√≥n?</p>
          <button @click="enviarVerificacion" class="btn btn-secondary" :disabled="enviandoVerificacion">
            {{ enviandoVerificacion ? 'Enviando...' : 'Enviar de nuevo' }}
          </button>
        </div>
        <div v-if="verificacionEnviada" class="verification-message">
          <p>{{ verificacionMensaje }}</p>
        </div>
        <div class="actions mt-3">
          <router-link to="/login" class="btn btn-primary">Ir al login</router-link>
        </div>
      </div>
      <form v-if="!registroExitoso" @submit.prevent="register">
        <div class="form-group">
          <label for="nombre">Nombre</label>
          <input
            type="text"
            id="nombre"
            v-model="nombre"
            class="form-control"
            required
            placeholder="Tu nombre"
            :disabled="loading"
          />
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input
            type="email"
            id="email"
            v-model="email"
            class="form-control"
            required
            placeholder="Tu email"
            :disabled="loading"
          />
        </div>
        <div class="form-group">
          <label for="password">Contrase√±a</label>
          <div class="password-field-container">
            <input
              :type="showPassword ? 'text' : 'password'"
              id="password"
              v-model="password"
              class="form-control"
              required
              placeholder="Contrase√±a (m√≠nimo 6 caracteres)"
              minlength="6"
              :disabled="loading"
            />
            <button 
              type="button"
              class="password-toggle-btn"
              @click="showPassword = !showPassword"
              tabindex="-1"
            >
              <i v-if="showPassword">üëÅÔ∏è</i>
              <i v-else>üëÅÔ∏è‚Äçüó®Ô∏è</i>
            </button>
          </div>
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirmar Contrase√±a</label>
          <div class="password-field-container">
            <input
              :type="showConfirmPassword ? 'text' : 'password'"
              id="confirmPassword"
              v-model="confirmPassword"
              class="form-control"
              required
              placeholder="Repite tu contrase√±a"
              minlength="6"
              :disabled="loading"
            />
            <button 
              type="button"
              class="password-toggle-btn"
              @click="showConfirmPassword = !showConfirmPassword"
              tabindex="-1"
            >
              <i v-if="showConfirmPassword">üëÅÔ∏è</i>
              <i v-else>üëÅÔ∏è‚Äçüó®Ô∏è</i>
            </button>
          </div>
        </div>
        <div v-if="loading" class="loading-state">
          <div v-if="guardandoEnFirebase" class="loading-message">
            <div class="spinner-small"></div>
            <span>Registrando en Firebase...</span>
          </div>
          <div v-else-if="guardandoEnBackend" class="loading-message">
            <div class="spinner-small"></div>
            <span>Guardando tus datos...</span>
          </div>
          <div v-else class="loading-message">
            <div class="spinner-small"></div>
            <span>Procesando...</span>
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="btn btn-primary" :disabled="loading || !passwordsMatch">
            {{ loading ? 'Registrando...' : 'Crear Cuenta' }}
          </button>
        </div>
        
        <!-- Separador -->
        <div class="separator">
          <span>o</span>
        </div>
        
        <!-- Bot√≥n de Google -->
        <div class="social-login">
          <button type="button" class="btn-google" @click="registerWithGoogle" :disabled="loading">
            <img src="@/assets/img/google_logo.png" alt="Google Logo" class="google-icon">
            Reg√≠strate con Google
          </button>
        </div>
        
        <div class="login-link">
          ¬øYa tienes cuenta? <router-link to="/login">Inicia sesi√≥n</router-link>
        </div>
      </form>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { useRouter } from 'vue-router';
import { useAuthStore } from '../stores/auth';
import AuthService from '../services/AuthService';
import axios from 'axios';
import FirebaseAuthService from '../services/FirebaseAuthService';
import { getAuth } from 'firebase/auth';

const router = useRouter();
const authStore = useAuthStore();
const nombre = ref('');
const email = ref('');
const password = ref('');
const confirmPassword = ref('');
const error = ref('');
const loading = ref(false);
const registroExitoso = ref(false);
const enviandoVerificacion = ref(false);
const verificacionEnviada = ref(false);
const verificacionMensaje = ref('');
const emailRegistrado = ref('');
const guardandoEnBackend = ref(false);
const guardandoEnFirebase = ref(false);

// Estados para controlar la visibilidad de las contrase√±as
const showPassword = ref(false);
const showConfirmPassword = ref(false);

// Obtener la instancia de auth
const auth = getAuth();

const passwordsMatch = computed(() => {
  return password.value === confirmPassword.value || confirmPassword.value === '';
});

const register = async () => {
  if (!passwordsMatch.value) {
    error.value = 'Las contrase√±as no coinciden';
    return;
  }
  
  try {
    loading.value = true;
    error.value = '';
    
    // 1. Crear usuario en Firebase
    try {
      guardandoEnFirebase.value = true;
      // Primero intentamos registrar al usuario con Firebase
      await FirebaseAuthService.register(email.value, password.value);
      guardandoEnFirebase.value = false;
      
      // 2. Crear usuario en el backend
      guardandoEnBackend.value = true;
      try {
      await AuthService.register({
        nombre: nombre.value,
        email: email.value,
        password: password.value
      });
        
      guardandoEnBackend.value = false;
      
      // Guardar el email para posible reenv√≠o de verificaci√≥n
      emailRegistrado.value = email.value;
      
      // Mostrar mensaje de √©xito y pedir verificaci√≥n
      registroExitoso.value = true;
      } catch (backendError) {
        guardandoEnBackend.value = false;
        console.error("Error en registro de backend:", backendError);
        throw backendError; // Relanzar para que sea capturado por el catch externo
      }
    } catch (firebaseError) {
      console.error('Error al registrar con Firebase:', firebaseError);
      guardandoEnFirebase.value = false;
      
      // Si el email ya existe, mostramos un error espec√≠fico
      if (firebaseError.code === 'auth/email-already-in-use') {
        error.value = 'Este correo electr√≥nico ya est√° registrado. Si es tuyo, intenta iniciar sesi√≥n.';
        loading.value = false;
        return;
      }
      
      // Si es otro error de Firebase pero no es de email existente, intentamos con el backend
      guardandoEnBackend.value = true;
      try {
        await AuthService.register({
          nombre: nombre.value,
          email: email.value,
          password: password.value
        });
        
        guardandoEnBackend.value = false;
        emailRegistrado.value = email.value;
        
        registroExitoso.value = true;
      } catch (backendError) {
        guardandoEnBackend.value = false;
        console.error('Error al registrar con backend:', backendError);
        
        // Manejamos errores espec√≠ficos del backend
        if (backendError.response?.data && typeof backendError.response.data === 'string') {
          if (backendError.response.data.includes('ya est√° registrado')) {
            error.value = 'Este correo electr√≥nico ya est√° registrado. Por favor, inicia sesi√≥n o usa otro email.';
          } else if (backendError.response.data.includes('demasiados intentos')) {
            error.value = 'Se han realizado demasiados intentos. Por favor, espera unos minutos e int√©ntalo de nuevo.';
          } else {
            error.value = backendError.response.data;
          }
        } else {
          error.value = 'Error al crear la cuenta. Por favor, int√©ntalo de nuevo m√°s tarde.';
        }
      }
    }
  } catch (err) {
    console.error('Error general de registro:', err);
    guardandoEnFirebase.value = false;
    guardandoEnBackend.value = false;
    
    // Manejar mensajes de error espec√≠ficos
    if (err.response?.data && typeof err.response.data === 'string') {
      // Si el mensaje contiene informaci√≥n sobre demasiados intentos
      if (err.response.data.includes('demasiados intentos')) {
        error.value = 'Se han realizado demasiados intentos de registro. Por favor, espera unos minutos antes de intentarlo nuevamente.';
      } else if (err.response.data.includes('ya est√° registrado')) {
        error.value = 'Este correo electr√≥nico ya est√° registrado. Intenta iniciar sesi√≥n o usar otro email.';
      } else {
        error.value = err.response.data;
      }
    } else if (err.code) {
      // Errores espec√≠ficos de Firebase
      switch (err.code) {
        case 'auth/email-already-in-use':
          error.value = 'Este correo electr√≥nico ya est√° en uso.';
          break;
        case 'auth/invalid-email':
          error.value = 'El formato del correo electr√≥nico no es v√°lido.';
          break;
        case 'auth/weak-password':
          error.value = 'La contrase√±a es demasiado d√©bil. Utiliza al menos 6 caracteres.';
          break;
        case 'auth/too-many-requests':
          error.value = 'Se han realizado demasiados intentos. Por favor, espera unos minutos antes de intentarlo nuevamente.';
          break;
        default:
          error.value = 'Error al crear la cuenta. Int√©ntalo de nuevo m√°s tarde.';
      }
    } else {
      error.value = 'Error al crear la cuenta. Int√©ntalo de nuevo m√°s tarde.';
    }
  } finally {
    loading.value = false;
  }
};

const enviarVerificacion = async () => {
  try {
    enviandoVerificacion.value = true;
    error.value = '';
    
    // Usar el email que se registr√≥
    const emailToUse = emailRegistrado.value || email.value;
    
    if (!emailToUse) {
      error.value = 'No hay un email v√°lido para enviar la verificaci√≥n.';
      return;
    }
    
    // Primero intentamos usar Firebase directamente
    try {
      // Iniciar sesi√≥n con Firebase para obtener el usuario
      const user = await FirebaseAuthService.login(emailToUse, password.value);
      
      // Enviar email de verificaci√≥n
      await FirebaseAuthService.sendVerificationEmail(user);
      
      verificacionEnviada.value = true;
      verificacionMensaje.value = 'Se ha enviado un correo de verificaci√≥n. Por favor, revisa tu bandeja de entrada.';
      
    } catch (firebaseError) {
      console.error('Error al usar Firebase directamente:', firebaseError);
      
      if (firebaseError.code === 'auth/wrong-password') {
        error.value = 'La contrase√±a es incorrecta para este email.';
        return;
      }
      
      // Si falla Firebase, caemos al m√©todo del backend
      try {
        const response = await axios.get(
          `http://localhost:8080/api/auth/enviar-verificacion?email=${encodeURIComponent(emailToUse)}`
        );
        
        verificacionEnviada.value = true;
        verificacionMensaje.value = response.data || 'Se ha enviado un nuevo correo de verificaci√≥n.';
      } catch (backendError) {
        console.error('Error con backend:', backendError);
        
        // Si tambi√©n falla el backend, mostramos un mensaje de error claro
        if (backendError.response?.data && typeof backendError.response.data === 'string') {
          if (backendError.response.data.includes('demasiados intentos')) {
            error.value = 'Se han realizado demasiados intentos de env√≠o. Por favor, espera unos minutos e int√©ntalo de nuevo.';
          } else if (backendError.response.data.includes('no se encontr√≥')) {
            error.value = 'No se encontr√≥ ning√∫n usuario con este email en nuestro sistema.';
          } else {
            error.value = backendError.response.data;
          }
        } else {
          error.value = 'No se pudo enviar el correo de verificaci√≥n. Por favor, int√©ntalo m√°s tarde.';
        }
      }
    }
  } catch (err) {
    console.error('Error al enviar verificaci√≥n:', err);
    
    if (err.code) {
      // Errores espec√≠ficos de Firebase
      switch (err.code) {
        case 'auth/user-not-found':
          error.value = 'No se encontr√≥ ning√∫n usuario con este correo electr√≥nico.';
          break;
        case 'auth/wrong-password':
          error.value = 'La contrase√±a es incorrecta.';
          break;
        case 'auth/too-many-requests':
          error.value = 'Se han realizado demasiados intentos. Por favor, espera unos minutos antes de intentarlo nuevamente.';
          break;
        default:
          error.value = 'No se pudo enviar el correo de verificaci√≥n.';
      }
    } else {
      error.value = err.response?.data || 'No se pudo enviar el correo de verificaci√≥n.';
    }
  } finally {
    enviandoVerificacion.value = false;
  }
};

// Registrarse con Google
const registerWithGoogle = async () => {
  try {
    loading.value = true;
    error.value = '';
    
    // Iniciar sesi√≥n con Google usando Firebase
    const user = await FirebaseAuthService.loginWithGoogle();
    
    // Todos los usuarios de Google deber√≠an ser autom√°ticamente verificados
    if (!user.emailVerified) {
      try {
        console.log("Usuario Google no est√° marcado como verificado, actualizando estado...");
        
        // Primero intentar actualizar localmente
        try {
          await user.updateProfile({
            // No cambiamos nada, solo para forzar una actualizaci√≥n
            displayName: user.displayName
          });
          await user.reload();
        } catch (updateError) {
          console.warn("No se pudo actualizar/recargar usuario:", updateError);
        }
        
        // Si sigue sin estar verificado, forzar en el backend
        if (!user.emailVerified) {
          // Forzar marcado como verificado en el backend
          const verificationResponse = await axios.get(
            `http://localhost:8080/api/auth/forzar-verificacion?email=${encodeURIComponent(user.email)}`
          );
          
          // Intentar marcar al usuario como verificado tambi√©n en Firebase
          try {
            await user.getIdToken(true); // Forzar renovaci√≥n del token
            await user.reload(); // Recargar datos del usuario
          } catch (reloadError) {
            console.warn("No se pudo recargar el usuario:", reloadError);
          }
        }
      } catch (verificationError) {
        console.warn("No se pudo forzar la verificaci√≥n:", verificationError);
        // No bloqueamos el flujo si esto falla
      }
    } else {
      console.log("Usuario Google ya est√° verificado:", user.emailVerified);
    }
    
    guardandoEnBackend.value = true;
    
    // Guardar el UID para posibles recuperaciones de sesi√≥n
    sessionStorage.setItem('firebaseUid', user.uid);
    
    // Datos para registro/login con Google
    const googleData = {
      email: user.email,
      password: `google-auth-${user.uid}`, // Contrase√±a que nunca ser√° usada directamente
      nombre: user.displayName || user.email.split('@')[0]
    };
    
    // Intentar iniciar sesi√≥n primero (por si el usuario ya existe)
    try {
      const loginResponse = await AuthService.login(googleData);
            
      // Login exitoso, el usuario ya exist√≠a
      emailRegistrado.value = user.email;
      guardandoEnBackend.value = false;
      
      // Verificar expl√≠citamente que ambos sistemas est√©n sincronizados
      const currentUser = auth.currentUser;
      const jwtToken = localStorage.getItem('authToken');
      
      if (!currentUser && jwtToken) {
        // Restaurar la sesi√≥n en Firebase 
        try {
          window.location.reload();
          return;
        } catch (reAuthError) {
          console.error("No se pudo restablecer la sesi√≥n de Firebase:", reAuthError);
        }
      }
      
      // Redirigir directamente al dashboard ya que el usuario ya existe y est√° autenticado
      setTimeout(() => {
        router.push('/');
      }, 1000);
      
      return;
    } catch (loginError) {
      // Si falla el login, el usuario no existe y continuamos con el registro
      console.log("Usuario no encontrado, procediendo a registrarlo");
    }
    
    try {
      // Registrar nuevo usuario
      await AuthService.register(googleData);      
      
      // Peque√±a pausa para asegurar que la sincronizaci√≥n se complete
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      try {
        // Despu√©s del registro exitoso, intentamos iniciar sesi√≥n
        console.log("Intentando login despu√©s del registro...");
        await AuthService.login(googleData);
        
        console.log("Login despu√©s de registro exitoso");
        
        guardandoEnBackend.value = false;
        
        // Mostrar mensaje de √©xito
        emailRegistrado.value = user.email;
        registroExitoso.value = true;
        
        // Como los usuarios de Google ya est√°n verificados, redirigimos al dashboard
        setTimeout(() => {
          router.push('/');
        }, 2000);
      } catch (postRegisterLoginError) {
        console.error("Error en login post-registro:", postRegisterLoginError);
        
        // Intento alternativo: si falla el login despu√©s del registro,
        // intentar forzar login guardando el token manualmente
        try {
          console.log("Intentando login alternativo...");
          // Obtener token usando Firebase directamente
          const idToken = await user.getIdToken();
          localStorage.setItem('authToken', idToken);
          
          // Tambi√©n guardaremos informaci√≥n b√°sica del usuario
          localStorage.setItem('userData', JSON.stringify({
            nombre: user.displayName || user.email.split('@')[0],
            email: user.email
          }));
          
          console.log("Login alternativo exitoso");
          
          guardandoEnBackend.value = false;
          emailRegistrado.value = user.email;
          registroExitoso.value = true;
          
          // Redirigir al dashboard
          setTimeout(() => {
            router.push('/');
          }, 2000);
        } catch (tokenError) {
          console.error("Error en login alternativo:", tokenError);
          guardandoEnBackend.value = false;
          error.value = 'Error al iniciar sesi√≥n despu√©s del registro. Por favor, intenta iniciar sesi√≥n normalmente.';
        }
      }
    } catch (registerError) {
      guardandoEnBackend.value = false;
      console.error('Error al registrar usuario de Google en el backend:', registerError);
      
      if (registerError.response && registerError.response.data) {
        // Analizar el mensaje de error para dar retroalimentaci√≥n espec√≠fica
        const errorMsg = typeof registerError.response.data === 'string' 
          ? registerError.response.data 
          : JSON.stringify(registerError.response.data);
        
        if (errorMsg.includes("ya est√° registrado")) {
          console.log("Usuario ya registrado, intentando login final...");
          
          try {
            // Si ya est√° registrado, intentamos login una vez m√°s
            await new Promise(resolve => setTimeout(resolve, 1000));
            await AuthService.login(googleData);
            
            console.log("Login final exitoso");
            emailRegistrado.value = user.email;
            
            // Redirigir a la p√°gina de inicio de sesi√≥n despu√©s de un breve retraso
            setTimeout(() => {
              router.push('/');
            }, 2000);
            
            return;
          } catch (finalLoginError) {
            console.error("Error en login final:", finalLoginError);
            error.value = 'Este email ya est√° registrado, pero no pudimos iniciar sesi√≥n autom√°ticamente. Por favor, inicia sesi√≥n manualmente.';
            
            setTimeout(() => {
              router.push('/login');
            }, 3000);
          }
        } else {
          error.value = 'No se pudo completar el registro con Google: ' + errorMsg;
        }
      } else {
        error.value = 'No se pudo completar el registro con Google.';
      }
    }
  } catch (err) {
    console.error('Error al iniciar sesi√≥n con Google:', err);
    
    if (err.code === 'auth/popup-closed-by-user') {
      error.value = 'El proceso de registro fue cancelado.';
    } else if (err.code === 'auth/cancelled-popup-request') {
      // Este es un error com√∫n cuando se hace clic varias veces, no mostramos error
      error.value = '';
    } else {
      error.value = 'Error al registrarse con Google. Por favor, int√©ntalo de nuevo.';
    }
  } finally {
    loading.value = false;
  }
};
</script>

<style src="../assets/Register.css"></style>
